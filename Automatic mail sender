# -----------------------------------------------------------
# Programma in grado di cercare tra una lista fornita di utenti
# i file excel prodotti dal lettore di contatore elettrico e
# inviare i dati completi via mail agli utenti interessati
# (presenti nella lista e presenti nella lettura del contatore)
#
# (C) 2021 Simone Varischetti, Stabio, Svizzera
# email: simon.varischetti@gmail.com
#
# Se file python aperto per la prima volta, andare
# sul terminale e digitate i seguenti codici :
#
# pip install pandas
# pip install openpyxl
# pip install dask[complete]
#
# SOLO IN CASO DI MANUTENZIONE INSTALLARE ANCHE:
# pip install xlsxwriter
# pip install Datetime
# pip install xlwt
# -----------------------------------------------------------

import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders

import pandas as pd
import dask.dataframe as dd
from pandas import ExcelWriter
pd.options.mode.chained_assignment = None  # default='warn'

# -----------------------------------------------------------
# SEZIONE UTENTE

# Inserire la path con il nome del file.csv contenente i valori dei contatori
# nome_csv = 'D:\RAPPORTO_MENSILE\RAPP_mensile\A29032021_120340_rapporto_curva.csv'
nome_csv = 'D:\RAPPORTO_MENSILE\RAPP_mensile\A12042021_163122_rapporto_curva_2020.csv'

# Inserire la path con il nome del file.csv contenente la lista completa degli utenti
nome_lista_utenti = 'D:\RAPPORTO_MENSILE\RAPP_mensile\lista_utenti_aggiornata.csv'

# Inserire la mail del mittente
mail_mittente = 'gianpaolo.pontarolo@stabio.ch'     # 'amstabio@mlt-systems.com'

# Inserire il mese desiderato (1 = gennaio, 12 = dicembre)
Variabile_mese = 3

# Inserire l'anno desiderato
Variabile_anno = 2021
# -----------------------------------------------------------

# Inserire la password per utilizzare l'account gmail
# password = input("Digitare la password gmail nella finestra 'run' e premere invio: ")

nome_colonne = ['Nome Stazione',
                'Metering Code',
                'Data e Ora',
                'Energia A+/- R+/-',
                'Valore',
                'Dimensione kW/kVar',
                'Indice',
                'Fattore',
                'Abbonato']

dtype = {'Nome Stazione': 'object',
         'Metering Code': 'object',
         'Data e Ora': 'object',
         'Energia A+/- R+/-': 'object',
         'Valore': 'float64',
         'Dimensione kW/kVar': 'object',
         'Indice': 'int64',
         'Fattore': 'object',
         'Abbonato': 'float64'}

dask_df = dd.read_csv(nome_csv,
                      sep=';',
                      header=None,
                      skiprows=1,
                      decimal=',',
                      names=nome_colonne,
                      dtype=dtype)

dask_df["Fattore"] = dask_df["Fattore"].astype(str).astype(float)
df = dask_df.compute()

# Trasforma la data in formato leggibile dal programma
df["Data e Ora"] = pd.to_datetime(df["Data e Ora"],
                                  dayfirst=True)

df['Anno'] = df['Data e Ora'].dt.year
df['Mese'] = df['Data e Ora'].dt.month
df['Giorno'] = df['Data e Ora'].dt.day
df['Orario'] = [d.time() for d in df['Data e Ora']]

if Variabile_mese == 1:
    mese_nom = "Gennaio"
elif Variabile_mese == 2:
    mese_nom = "Febbraio"
elif Variabile_mese == 3:
    mese_nom = "Marzo"
elif Variabile_mese == 4:
    mese_nom = "Aprile"
elif Variabile_mese == 5:
    mese_nom = "Maggio"
elif Variabile_mese == 6:
    mese_nom = "Giugno"
elif Variabile_mese == 7:
    mese_nom = "Luglio"
elif Variabile_mese == 8:
    mese_nom = "Agosto"
elif Variabile_mese == 9:
    mese_nom = "Settembre"
elif Variabile_mese == 10:
    mese_nom = "Ottobre"
elif Variabile_mese == 11:
    mese_nom = "Novembre"
elif Variabile_mese == 12:
    mese_nom = "Dicembre"

nom_an = str(Variabile_anno)

df_nome = df["Nome Stazione"]
df_nome.drop_duplicates(keep="first", inplace=True)
# print(df_nome)
df_nome_lista = df_nome.tolist()
var_nome = df_nome.iloc[1]

writer = ExcelWriter("D:\RAPPORTO_MENSILE\RAPP_mensile\Tabella_utenti.xlsx")
df_nome.to_excel(writer, 'Sheet1')
writer.save()

# -----------------------------------------------------------
# ESPORTAZIONE DATI EXCEL -> MAIL UTENTI

# mittente = mail_mittente
mittente = mail_mittente
data_csv_destinatari = pd.read_csv(nome_lista_utenti)

# print(data_csv_destinatari)
print()

for x in range(len(df_nome_lista)):
    nome_1 = df_nome.iloc[x]
    var_ind = "D:\RAPPORTO_MENSILE\RAPP_mensile\Rapporti_out"
    var_fin = var_ind + "\\" + nome_1 + "_" + mese_nom + "_" + nom_an + ".xlsx"

    df_utente_sele = data_csv_destinatari[data_csv_destinatari['Nome_utente'] == nome_1]

    if not df_utente_sele.empty:
        for y in range(len(df_utente_sele)):
            mail_utente_sele = df_utente_sele['mail_utente'].iloc[y]
            lista_mail = [mail_utente_sele]
            nome_utente_sele = df_utente_sele['Nome_destin'].iloc[y]

            print("Stazione trovata:", nome_1)
            print("Nome destinatario:", nome_utente_sele)
            # print("Percorso del file da inviare: \n ", var_fin)
            print("Mail dell'utente:", mail_utente_sele)
            print(var_fin)
            print()

            msg = MIMEMultipart()
            msg['From'] = mittente
            msg['To'] = ", ".join(lista_mail)
            msg['Subject'] = "Rapporto mensile consumo elettrico " + mese_nom + "-" + nom_an + "-" + nome_1

            if df_utente_sele['Sesso_M/F'].iloc[y] == 'M':
                Testo_mail_s = "Egregio Signor " + nome_utente_sele + ", \n"
            elif df_utente_sele['Sesso_M/F'].iloc[y] == 'F':
                Testo_mail_s = "Gentile Signora " + nome_utente_sele + ", \n"

            testo_init = "In allegato trova il rapporto mensile dei vostri consumi elettrici su base oraria. \n \n" \
                         "I dati contenuti nel rapporto si discostano da quelli della fatturazione a causa del " \
                         "leggero sfasamento che vi Ã¨ tra il nostro sistema di rilevamento e quello ufficiale " \
                         "del nostro partner (AET). \n \n" \
                         "I dati per la fatturazione sono determinati dal sistema ufficiale. \n" \
                         "Nel caso non desiderate ricevere il rapporto o volete aggiungere altre persone, vi " \
                         "preghiamo di comunicarcelo. \n \n \n" \
                         "Rimango a vostra disposizione per eventuali domande. \n \n" \
                         "Cordiali saluti, \nG. Pontarolo \n \n \n--- \nGianpaolo Pontarolo \n" \
                         "dipl. El. Ing. ETH / lic. oec. pupl. \nDirettore AMS \n" \
                         "via rognano 6 / 6855 Stabio / +41 91 647 20 73 / +41 79 460 0905 / " \
                         "gianpaolo.pontarolo@stabio.ch"

            Testo_mail = Testo_mail_s + testo_init

            msg.attach(MIMEText(Testo_mail, 'plain'))
            filename = nome_1 + "_" + mese_nom + "_" + nom_an + ".xlsx"
            attachment = open(var_fin, "rb")

            part = MIMEBase('application', 'octet-stream')
            part.set_payload(attachment.read())
            encoders.encode_base64(part)
            part.add_header('Content-Disposition', "attachment; filename= %s" % filename)

            msg.attach(part)
            server = smtplib.SMTP(host="smtp.mlt-systems.ch", port=25)
            server.starttls()
            server.login('amstabio@mlt-systems.com', '564r9NBPe3H')
            server.ehlo()
            text = msg.as_string()
            server.sendmail(mittente, lista_mail, text)

            # Mail di verifica per ogni mail mandata
            server.sendmail(mittente, mittente, text)

server.quit()
